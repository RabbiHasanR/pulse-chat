
x-app-env: &app-env
  DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
  EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD}
  DATABASE_USER: ${POSTGRES_USER}
  DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
  DATABASE_NAME: ${POSTGRES_DB}
  DATABASE_HOST: db
  DATABASE_PORT: 5432
  REDIS_HOST: redis
  REDIS_PORT: 6379
  CELERY_BROKER_URL: redis://redis:6379/0
  CHANNEL_URL: redis://redis:6379/1
  CACHE_URL: redis://redis:6379/2
  DJANGO_DEBUG: "True"
  USE_S3_MOCK: "True"
  AWS_S3_ENDPOINT_URL: http://s3mock:5000
  AWS_ACCESS_KEY_ID: fake_key
  AWS_SECRET_ACCESS_KEY: fake_secret
  AWS_S3_REGION_NAME: us-east-1
  AWS_STORAGE_BUCKET_NAME: chat-bucket

services:
  db:
    build:
      context: ./database
      dockerfile: Dockerfile
    container_name: db
    hostname: db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./database/db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10
  

  redis:
    image: redis:7-alpine
    container_name: redis
    hostname: redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  
  s3mock:
    image: motoserver/moto:latest
    container_name: s3mock
    hostname: s3mock
    ports:
      - "5000:5000"
    environment:
      - MOTO_PORT=5000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000"]
      interval: 5s
      timeout: 5s
      retries: 5


  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: server
    container_name: server
    hostname: server
    environment: *app-env
    # environment:
    #   - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
    #   - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
    #   - DATABASE_USER=${POSTGRES_USER}
    #   - DATABASE_PASSWORD=${POSTGRES_PASSWORD}
    #   - DATABASE_NAME=${POSTGRES_DB}
    #   - DATABASE_HOST=db
    #   - DATABASE_PORT=5432
    #   - REDIS_HOST=redis
    #   - REDIS_PORT=6379
    #   - CELERY_BROKER_URL=redis://redis:6379/0
    #   - CHANNEL_URL=redis://redis:6379/1
    #   - CACHE_URL=redis://redis:6379/2
    #   - DJANGO_DEBUG=True                  
    #   - USE_S3_MOCK=True                   
    #   - AWS_S3_ENDPOINT_URL=http://s3mock:5000
    #   - AWS_ACCESS_KEY_ID=fake_key
    #   - AWS_SECRET_ACCESS_KEY=fake_secret
    #   - AWS_S3_REGION_NAME=us-east-1
    #   - AWS_STORAGE_BUCKET_NAME=chat-bucket
    ports:
      - "8000:8000"
    entrypoint: /app/entrypoint.sh
    # command: python manage.py runserver 0.0.0.0:8000
    command: >
      gunicorn core.asgi:application
      --workers=4
      --worker-class=uvicorn.workers.UvicornWorker
      --bind=0.0.0.0:8000
      --access-logfile - 
      --log-level info
    volumes:
      - ./server:/app
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
      s3mock:
        condition: service_healthy

  
  # celery:
  #   image: server
  #   container_name: celery
  #   hostname: celery
  #   environment:
  #     - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
  #     - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
  #     - DATABASE_USER=${POSTGRES_USER}
  #     - DATABASE_PASSWORD=${POSTGRES_PASSWORD}
  #     - DATABASE_NAME=${POSTGRES_DB}
  #     - DATABASE_HOST=db
  #     - DATABASE_PORT=5432
  #     - REDIS_HOST=redis
  #     - REDIS_PORT=6379
  #     - CELERY_BROKER_URL=redis://redis:6379/0
  #     - CHANNEL_URL=redis://redis:6379/1
  #     - CACHE_URL=redis://redis:6379/2
  #     - USE_S3_MOCK=True
  #     - AWS_S3_ENDPOINT_URL=http://s3mock:5000 # <--- Important!
  #     - AWS_ACCESS_KEY_ID=fake_key
  #     - AWS_SECRET_ACCESS_KEY=fake_secret
  #     - AWS_S3_REGION_NAME=us-east-1
  #     - AWS_STORAGE_BUCKET_NAME=chat-bucket
  #   command: celery -A core worker --loglevel=info
  #   volumes:
  #     - ./server:/app
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #     db:
  #       condition: service_healthy
  #     s3mock:
  #       condition: service_healthy



  # -----------------------------------------------------------------------------
  # 5. CELERY WORKER: DEFAULT (Notifications/Lightweight)
  # -----------------------------------------------------------------------------
  celery_default:
    image: server # Reuses the built image from 'server'
    container_name: celery_default
    hostname: celery_default
    environment: *app-env
    # Consumes ONLY 'default' queue
    command: celery -A core worker --loglevel=info -Q default --hostname=default@%h --concurrency=4
    volumes:
      - ./server:/app
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
      s3mock:
        condition: service_healthy

  # -----------------------------------------------------------------------------
  # 6. CELERY WORKER: MEDIA (Images, Audio, Files)
  # -----------------------------------------------------------------------------
  celery_media:
    image: server
    container_name: celery_media
    hostname: celery_media
    environment: *app-env
    # Consumes image, audio, and file queues
    command: celery -A core worker --loglevel=info -Q image_queue,audio_queue,file_queue --hostname=media@%h --concurrency=4
    volumes:
      - ./server:/app
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
      s3mock:
        condition: service_healthy

  # -----------------------------------------------------------------------------
  # 7. CELERY WORKER: VIDEO (Heavy Transcoding - Isolated)
  # -----------------------------------------------------------------------------
  celery_video:
    image: server
    container_name: celery_video
    hostname: celery_video
    environment: *app-env
    # Consumes ONLY 'video_queue'
    # Concurrency is LOW (2) to prevent FFmpeg from eating all RAM/CPU
    command: celery -A core worker --loglevel=info -Q video_queue --hostname=video@%h --concurrency=2
    volumes:
      - ./server:/app
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
      s3mock:
        condition: service_healthy
    




celery_beat:
    image: server_image
    container_name: celery_beat
    environment: *app-env
    command: celery -A core beat -l info
    volumes:
      - ./server:/app
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy